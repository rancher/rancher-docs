"use strict";(self.webpackChunkrancher_docs=self.webpackChunkrancher_docs||[]).push([[88055],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return m}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),u=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},c=function(e){var t=u(e.components);return n.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(a),m=r,k=p["".concat(i,".").concat(m)]||p[m]||d[m]||l;return a?n.createElement(k,o(o({ref:t},c),{},{components:a})):n.createElement(k,o({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,o=new Array(l);o[0]=p;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var u=2;u<l;u++)o[u]=a[u];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},68350:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return i},default:function(){return m},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return d}});var n=a(87462),r=a(63366),l=(a(67294),a(3905)),o=["components"],s={title:"Cluster Autoscaler with AWS EC2 Auto Scaling Groups",weight:1,aliases:["/rancher/v2.x/en/cluster-admin/cluster-autoscaler/amazon/"]},i=void 0,u={unversionedId:"how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups",id:"version-2.5/how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups",title:"Cluster Autoscaler with AWS EC2 Auto Scaling Groups",description:"This guide will show you how to install and use Kubernetes cluster-autoscaler on Rancher custom clusters using AWS EC2 Auto Scaling Groups.",source:"@site/versioned_docs/version-2.5/how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups.md",sourceDirName:"how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler",slug:"/how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups",permalink:"/v2.5/how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups",draft:!1,editUrl:"https://github.com/rancher/rancher-docs/edit/main/versioned_docs/version-2.5/how-to-guides/advanced-user-guides/manage-clusters/install-cluster-autoscaler/use-aws-ec2-auto-scaling-groups.md",tags:[],version:"2.5",lastUpdatedAt:1663710212,formattedLastUpdatedAt:"9/20/2022",frontMatter:{title:"Cluster Autoscaler with AWS EC2 Auto Scaling Groups",weight:1,aliases:["/rancher/v2.x/en/cluster-admin/cluster-autoscaler/amazon/"]},sidebar:"tutorialSidebar",previous:{title:"Cluster Autoscaler",permalink:"/v2.5/pages-for-subheaders/install-cluster-autoscaler"},next:{title:"Kubernetes Persistent Storage: Volumes and Storage Classes",permalink:"/v2.5/pages-for-subheaders/create-kubernetes-persistent-storage"}},c={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"1. Create a Custom Cluster",id:"1-create-a-custom-cluster",level:3},{value:"2. Configure the Cloud Provider",id:"2-configure-the-cloud-provider",level:3},{value:"3. Deploy Nodes",id:"3-deploy-nodes",level:3},{value:"4. Install Cluster-autoscaler",id:"4-install-cluster-autoscaler",level:3},{value:"Parameters",id:"parameters",level:4},{value:"Deployment",id:"deployment",level:4},{value:"Generating Load",id:"generating-load",level:3},{value:"Checking Scale",id:"checking-scale",level:3}],p={toc:d};function m(e){var t=e.components,a=(0,r.Z)(e,o);return(0,l.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"This guide will show you how to install and use ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/"},"Kubernetes cluster-autoscaler")," on Rancher custom clusters using AWS EC2 Auto Scaling Groups."),(0,l.kt)("p",null,"We are going to install a Rancher RKE custom cluster with a fixed number of nodes with the etcd and controlplane roles, and a variable nodes with the worker role, managed by ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster-autoscaler"),"."),(0,l.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("p",null,"These elements are required to follow this guide:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The Rancher server is up and running"),(0,l.kt)("li",{parentName:"ul"},"You have an AWS EC2 user with proper permissions to create virtual machines, auto scaling groups, and IAM profiles and roles")),(0,l.kt)("h3",{id:"1-create-a-custom-cluster"},"1. Create a Custom Cluster"),(0,l.kt)("p",null,"On Rancher server, we should create a custom k8s cluster. Refer ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/"},"here")," to check for version compatibility."),(0,l.kt)("p",null,"Be sure that cloud_provider name is set to ",(0,l.kt)("inlineCode",{parentName:"p"},"amazonec2"),". Once cluster is created we need to get:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"clusterID: ",(0,l.kt)("inlineCode",{parentName:"p"},"c-xxxxx")," will be used on EC2 ",(0,l.kt)("inlineCode",{parentName:"p"},"kubernetes.io/cluster/<clusterID>")," instance tag")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"clusterName: will be used on EC2 ",(0,l.kt)("inlineCode",{parentName:"p"},"k8s.io/cluster-autoscaler/<clusterName>")," instance tag")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"nodeCommand: will be added on EC2 instance user_data to include new nodes on cluster"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-sh"},"sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:<RANCHER_VERSION> --server https://<RANCHER_URL> --token <RANCHER_TOKEN> --ca-checksum <RANCHER_CHECKSUM> <roles>\n")))),(0,l.kt)("h3",{id:"2-configure-the-cloud-provider"},"2. Configure the Cloud Provider"),(0,l.kt)("p",null,"On AWS EC2, we should create a few objects to configure our system. We've defined three distinct groups and IAM profiles to configure on AWS."),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Autoscaling group: Nodes that will be part of the EC2 Auto Scaling Group (ASG). The ASG will be used by ",(0,l.kt)("inlineCode",{parentName:"li"},"cluster-autoscaler")," to scale up and down.")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"IAM profile: Required by k8s nodes where cluster-autoscaler will be running. It is recommended for Kubernetes master nodes. This profile is called ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sAutoscalerProfile"),"."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n                "autoscaling:DescribeAutoScalingGroups",\n                "autoscaling:DescribeAutoScalingInstances",\n                "autoscaling:DescribeLaunchConfigurations",\n                "autoscaling:SetDesiredCapacity",\n                "autoscaling:TerminateInstanceInAutoScalingGroup",\n                "autoscaling:DescribeTags",\n                "autoscaling:DescribeLaunchConfigurations",\n                "ec2:DescribeLaunchTemplateVersions"\n            ],\n            "Resource": [\n                "*"\n            ]\n        }\n    ]\n}\n')))),(0,l.kt)("ol",{start:2},(0,l.kt)("li",{parentName:"ol"},"Master group: Nodes that will be part of the Kubernetes etcd and/or control planes. This will be out of the ASG.")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"IAM profile: Required by the Kubernetes cloud_provider integration. Optionally, ",(0,l.kt)("inlineCode",{parentName:"p"},"AWS_ACCESS_KEY")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"AWS_SECRET_KEY")," can be used instead ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md#using-aws-credentials"},"using-aws-credentials.")," This profile is called ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sMasterProfile"),"."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n                "autoscaling:DescribeAutoScalingGroups",\n                "autoscaling:DescribeLaunchConfigurations",\n                "autoscaling:DescribeTags",\n                "ec2:DescribeInstances",\n                "ec2:DescribeRegions",\n                "ec2:DescribeRouteTables",\n                "ec2:DescribeSecurityGroups",\n                "ec2:DescribeSubnets",\n                "ec2:DescribeVolumes",\n                "ec2:CreateSecurityGroup",\n                "ec2:CreateTags",\n                "ec2:CreateVolume",\n                "ec2:ModifyInstanceAttribute",\n                "ec2:ModifyVolume",\n                "ec2:AttachVolume",\n                "ec2:AuthorizeSecurityGroupIngress",\n                "ec2:CreateRoute",\n                "ec2:DeleteRoute",\n                "ec2:DeleteSecurityGroup",\n                "ec2:DeleteVolume",\n                "ec2:DetachVolume",\n                "ec2:RevokeSecurityGroupIngress",\n                "ec2:DescribeVpcs",\n                "elasticloadbalancing:AddTags",\n                "elasticloadbalancing:AttachLoadBalancerToSubnets",\n                "elasticloadbalancing:ApplySecurityGroupsToLoadBalancer",\n                "elasticloadbalancing:CreateLoadBalancer",\n                "elasticloadbalancing:CreateLoadBalancerPolicy",\n                "elasticloadbalancing:CreateLoadBalancerListeners",\n                "elasticloadbalancing:ConfigureHealthCheck",\n                "elasticloadbalancing:DeleteLoadBalancer",\n                "elasticloadbalancing:DeleteLoadBalancerListeners",\n                "elasticloadbalancing:DescribeLoadBalancers",\n                "elasticloadbalancing:DescribeLoadBalancerAttributes",\n                "elasticloadbalancing:DetachLoadBalancerFromSubnets",\n                "elasticloadbalancing:DeregisterInstancesFromLoadBalancer",\n                "elasticloadbalancing:ModifyLoadBalancerAttributes",\n                "elasticloadbalancing:RegisterInstancesWithLoadBalancer",\n                "elasticloadbalancing:SetLoadBalancerPoliciesForBackendServer",\n                "elasticloadbalancing:AddTags",\n                "elasticloadbalancing:CreateListener",\n                "elasticloadbalancing:CreateTargetGroup",\n                "elasticloadbalancing:DeleteListener",\n                "elasticloadbalancing:DeleteTargetGroup",\n                "elasticloadbalancing:DescribeListeners",\n                "elasticloadbalancing:DescribeLoadBalancerPolicies",\n                "elasticloadbalancing:DescribeTargetGroups",\n                "elasticloadbalancing:DescribeTargetHealth",\n                "elasticloadbalancing:ModifyListener",\n                "elasticloadbalancing:ModifyTargetGroup",\n                "elasticloadbalancing:RegisterTargets",\n                "elasticloadbalancing:SetLoadBalancerPoliciesOfListener",\n                "iam:CreateServiceLinkedRole",\n                "ecr:GetAuthorizationToken",\n                "ecr:BatchCheckLayerAvailability",\n                "ecr:GetDownloadUrlForLayer",\n                "ecr:GetRepositoryPolicy",\n                "ecr:DescribeRepositories",\n                "ecr:ListImages",\n                "ecr:BatchGetImage",\n                "kms:DescribeKey"\n            ],\n            "Resource": [\n                "*"\n            ]\n        }\n    ]\n}\n')),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"IAM role: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sMasterRole: [K8sMasterProfile,K8sAutoscalerProfile]"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Security group: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sMasterSg")," More info at",(0,l.kt)("a",{parentName:"p",href:"/v2.5/getting-started/installation-and-upgrade/installation-requirements/port-requirements#downstream-kubernetes-cluster-nodes"},"RKE ports (custom nodes tab)"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Tags:\n",(0,l.kt)("inlineCode",{parentName:"p"},"kubernetes.io/cluster/<clusterID>: owned"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"User data: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sMasterUserData")," Ubuntu 18.04(ami-0e11cbb34015ff725), installs docker and add etcd+controlplane node to the k8s cluster"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash -x\n\ncat <<EOF > /etc/sysctl.d/90-kubelet.conf\nvm.overcommit_memory = 1\nvm.panic_on_oom = 0\nkernel.panic = 10\nkernel.panic_on_oops = 1\nkernel.keys.root_maxkeys = 1000000\nkernel.keys.root_maxbytes = 25000000\nEOF\nsysctl -p /etc/sysctl.d/90-kubelet.conf\n\ncurl -sL https://releases.rancher.com/install-docker/19.03.sh | sh\nsudo usermod -aG docker ubuntu\n\nTOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")\nPRIVATE_IP=$(curl -H "X-aws-ec2-metadata-token: ${TOKEN}" -s http://169.254.169.254/latest/meta-data/local-ipv4)\nPUBLIC_IP=$(curl -H "X-aws-ec2-metadata-token: ${TOKEN}" -s http://169.254.169.254/latest/meta-data/public-ipv4)\nK8S_ROLES="--etcd --controlplane"\n\nsudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:<RANCHER_VERSION> --server https://<RANCHER_URL> --token <RANCHER_TOKEN> --ca-checksum <RANCHER_CA_CHECKSUM> --address ${PUBLIC_IP} --internal-address ${PRIVATE_IP} ${K8S_ROLES}\n')))))),(0,l.kt)("ol",{start:3},(0,l.kt)("li",{parentName:"ol"},"Worker group: Nodes that will be part of the k8s worker plane. Worker nodes will be scaled by cluster-autoscaler using the ASG.")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"IAM profile: Provides cloud_provider worker integration.\nThis profile is called ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sWorkerProfile"),"."),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre"},'```json\n{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": [\n                "ec2:DescribeInstances",\n                "ec2:DescribeRegions",\n                "ecr:GetAuthorizationToken",\n                "ecr:BatchCheckLayerAvailability",\n                "ecr:GetDownloadUrlForLayer",\n                "ecr:GetRepositoryPolicy",\n                "ecr:DescribeRepositories",\n                "ecr:ListImages",\n                "ecr:BatchGetImage"\n            ],\n            "Resource": "*"\n        }\n    ]\n}\n```\n'))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"IAM role: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sWorkerRole: [K8sWorkerProfile]"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Security group: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sWorkerSg")," More info at ",(0,l.kt)("a",{parentName:"p",href:"/v2.5/getting-started/installation-and-upgrade/installation-requirements/port-requirements#downstream-kubernetes-cluster-nodes"},"RKE ports (custom nodes tab)"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"Tags:"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kubernetes.io/cluster/<clusterID>: owned")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"k8s.io/cluster-autoscaler/<clusterName>: true")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"k8s.io/cluster-autoscaler/enabled: true")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"User data: ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sWorkerUserData")," Ubuntu 18.04(ami-0e11cbb34015ff725), installs docker and add worker node to the k8s cluster"),(0,l.kt)("pre",{parentName:"li"},(0,l.kt)("code",{parentName:"pre",className:"language-sh"},'#!/bin/bash -x\n\ncat <<EOF > /etc/sysctl.d/90-kubelet.conf\nvm.overcommit_memory = 1\nvm.panic_on_oom = 0\nkernel.panic = 10\nkernel.panic_on_oops = 1\nkernel.keys.root_maxkeys = 1000000\nkernel.keys.root_maxbytes = 25000000\nEOF\nsysctl -p /etc/sysctl.d/90-kubelet.conf\n\ncurl -sL https://releases.rancher.com/install-docker/19.03.sh | sh\nsudo usermod -aG docker ubuntu\n\nTOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")\nPRIVATE_IP=$(curl -H "X-aws-ec2-metadata-token: ${TOKEN}" -s http://169.254.169.254/latest/meta-data/local-ipv4)\nPUBLIC_IP=$(curl -H "X-aws-ec2-metadata-token: ${TOKEN}" -s http://169.254.169.254/latest/meta-data/public-ipv4)\nK8S_ROLES="--worker"\n\nsudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:<RANCHER_VERSION> --server https://<RANCHER_URL> --token <RANCHER_TOKEN> --ca-checksum <RANCHER_CA_CHECKCSUM> --address ${PUBLIC_IP} --internal-address ${PRIVATE_IP} ${K8S_ROLES}\n')))),(0,l.kt)("p",null,"More info is at ",(0,l.kt)("a",{parentName:"p",href:"/v2.5/how-to-guides/new-user-guides/kubernetes-clusters-in-rancher-setup/launch-kubernetes-with-rancher/set-up-cloud-providers/other-cloud-providers/amazon"},"RKE clusters on AWS")," and ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md"},"Cluster Autoscaler on AWS.")),(0,l.kt)("h3",{id:"3-deploy-nodes"},"3. Deploy Nodes"),(0,l.kt)("p",null,"Once we've configured AWS, let's create VMs to bootstrap our cluster:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"master (etcd+controlplane): Depending your needs, deploy three master instances with proper size. More info is at ",(0,l.kt)("a",{parentName:"p",href:"/v2.5/pages-for-subheaders/checklist-for-production-ready-clusters"},"the recommendations for production-ready clusters.")),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"IAM role: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sMasterRole")),(0,l.kt)("li",{parentName:"ul"},"Security group: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sMasterSg")),(0,l.kt)("li",{parentName:"ul"},"Tags:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kubernetes.io/cluster/<clusterID>: owned")))),(0,l.kt)("li",{parentName:"ul"},"User data: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sMasterUserData")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},"worker: Define an ASG on EC2 with the following settings:"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Name: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sWorkerAsg")),(0,l.kt)("li",{parentName:"ul"},"IAM role: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sWorkerRole")),(0,l.kt)("li",{parentName:"ul"},"Security group: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sWorkerSg")),(0,l.kt)("li",{parentName:"ul"},"Tags:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"kubernetes.io/cluster/<clusterID>: owned")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"k8s.io/cluster-autoscaler/<clusterName>: true")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"k8s.io/cluster-autoscaler/enabled: true")))),(0,l.kt)("li",{parentName:"ul"},"User data: ",(0,l.kt)("inlineCode",{parentName:"li"},"K8sWorkerUserData")),(0,l.kt)("li",{parentName:"ul"},"Instances:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"minimum: 2"),(0,l.kt)("li",{parentName:"ul"},"desired: 2"),(0,l.kt)("li",{parentName:"ul"},"maximum: 10")))))),(0,l.kt)("p",null,"Once the VMs are deployed, you should have a Rancher custom cluster up and running with three master and two worker nodes."),(0,l.kt)("h3",{id:"4-install-cluster-autoscaler"},"4. Install Cluster-autoscaler"),(0,l.kt)("p",null,"At this point, we should have rancher cluster up and running. We are going to install cluster-autoscaler on master nodes and ",(0,l.kt)("inlineCode",{parentName:"p"},"kube-system")," namespace, following cluster-autoscaler recommendation."),(0,l.kt)("h4",{id:"parameters"},"Parameters"),(0,l.kt)("p",null,"This table shows cluster-autoscaler parameters for fine tuning:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,l.kt)("th",{parentName:"tr",align:null},"Default"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cluster-name"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Autoscaled cluster name, if available")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"address"),(0,l.kt)("td",{parentName:"tr",align:null},":8085"),(0,l.kt)("td",{parentName:"tr",align:null},"The address to expose Prometheus metrics")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"kubernetes"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Kubernetes master location. Leave blank for default")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"kubeconfig"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Path to kubeconfig file with authorization and master location information")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cloud-config"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"The path to the cloud provider configuration file.  Empty string for no configuration file")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"namespace"),(0,l.kt)("td",{parentName:"tr",align:null},'"kube-system"'),(0,l.kt)("td",{parentName:"tr",align:null},"Namespace in which cluster-autoscaler run")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-enabled"),(0,l.kt)("td",{parentName:"tr",align:null},"true"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA scale down the cluster")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-delay-after-add"),(0,l.kt)("td",{parentName:"tr",align:null},'"10m"'),(0,l.kt)("td",{parentName:"tr",align:null},"How long after scale up that scale down evaluation resumes")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-delay-after-delete"),(0,l.kt)("td",{parentName:"tr",align:null},"0"),(0,l.kt)("td",{parentName:"tr",align:null},"How long after node deletion that scale down evaluation resumes, defaults to scanInterval")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-delay-after-failure"),(0,l.kt)("td",{parentName:"tr",align:null},'"3m"'),(0,l.kt)("td",{parentName:"tr",align:null},"How long after scale down failure that scale down evaluation resumes")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-unneeded-time"),(0,l.kt)("td",{parentName:"tr",align:null},'"10m"'),(0,l.kt)("td",{parentName:"tr",align:null},"How long a node should be unneeded before it is eligible for scale down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-unready-time"),(0,l.kt)("td",{parentName:"tr",align:null},'"20m"'),(0,l.kt)("td",{parentName:"tr",align:null},"How long an unready node should be unneeded before it is eligible for scale down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-utilization-threshold"),(0,l.kt)("td",{parentName:"tr",align:null},"0.5"),(0,l.kt)("td",{parentName:"tr",align:null},"Sum of cpu or memory of all pods running on the node divided by node's corresponding allocatable resource, below which a node can be considered for scale down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-gpu-utilization-threshold"),(0,l.kt)("td",{parentName:"tr",align:null},"0.5"),(0,l.kt)("td",{parentName:"tr",align:null},"Sum of gpu requests of all pods running on the node divided by node's allocatable resource, below which a node can be considered for scale down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-non-empty-candidates-count"),(0,l.kt)("td",{parentName:"tr",align:null},"30"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum number of non empty nodes considered in one iteration as candidates for scale down with drain")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-candidates-pool-ratio"),(0,l.kt)("td",{parentName:"tr",align:null},"0.1"),(0,l.kt)("td",{parentName:"tr",align:null},"A ratio of nodes that are considered as additional non empty candidates for scale down when some candidates from previous iteration are no longer valid")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-down-candidates-pool-min-count"),(0,l.kt)("td",{parentName:"tr",align:null},"50"),(0,l.kt)("td",{parentName:"tr",align:null},"Minimum number of nodes that are considered as additional non empty candidates for scale down when some candidates from previous iteration are no longer valid")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"node-deletion-delay-timeout"),(0,l.kt)("td",{parentName:"tr",align:null},'"2m"'),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum time CA waits for removing delay-deletion.cluster-autoscaler.kubernetes.io/ annotations before deleting the node")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scan-interval"),(0,l.kt)("td",{parentName:"tr",align:null},'"10s"'),(0,l.kt)("td",{parentName:"tr",align:null},"How often cluster is reevaluated for scale up or down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-nodes-total"),(0,l.kt)("td",{parentName:"tr",align:null},"0"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum number of nodes in all node groups. Cluster autoscaler will not grow the cluster beyond this number")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cores-total"),(0,l.kt)("td",{parentName:"tr",align:null},'"0:320000"'),(0,l.kt)("td",{parentName:"tr",align:null},"Minimum and maximum number of cores in cluster, in the format ",(0,l.kt)("inlineCode",{parentName:"td"},"<min>:<max>.")," Cluster autoscaler will not scale the cluster beyond these numbers")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"memory-total"),(0,l.kt)("td",{parentName:"tr",align:null},'"0:6400000"'),(0,l.kt)("td",{parentName:"tr",align:null},"Minimum and maximum number of gigabytes of memory in cluster, in the format ",(0,l.kt)("inlineCode",{parentName:"td"},"<min>:<max>.")," Cluster autoscaler will not scale the cluster beyond these numbers")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cloud-provider"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Cloud provider type")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-bulk-soft-taint-count"),(0,l.kt)("td",{parentName:"tr",align:null},"10"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum number of nodes that can be tainted/untainted PreferNoSchedule at the same time. Set to 0 to turn off such tainting")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-bulk-soft-taint-time"),(0,l.kt)("td",{parentName:"tr",align:null},'"3s"'),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum duration of tainting/untainting nodes as PreferNoSchedule at the same time")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-empty-bulk-delete"),(0,l.kt)("td",{parentName:"tr",align:null},"10"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum number of empty nodes that can be deleted at the same time")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-graceful-termination-sec"),(0,l.kt)("td",{parentName:"tr",align:null},"600"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum number of seconds CA waits for pod termination when trying to scale down a node")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-total-unready-percentage"),(0,l.kt)("td",{parentName:"tr",align:null},"45"),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum percentage of unready nodes in the cluster.  After this is exceeded, CA halts operations")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ok-total-unready-count"),(0,l.kt)("td",{parentName:"tr",align:null},"3"),(0,l.kt)("td",{parentName:"tr",align:null},"Number of allowed unready nodes, irrespective of max-total-unready-percentage")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"scale-up-from-zero"),(0,l.kt)("td",{parentName:"tr",align:null},"true"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA scale up when there 0 ready nodes")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-node-provision-time"),(0,l.kt)("td",{parentName:"tr",align:null},'"15m"'),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum time CA waits for node to be provisioned")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"nodes"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"sets min,max size and other configuration data for a node group in a format accepted by cloud provider. Can be used multiple times. Format: ",(0,l.kt)("inlineCode",{parentName:"td"},"<min>:<max>:<other...>"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"node-group-auto-discovery"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"One or more definition(s) of node group auto-discovery. A definition is expressed ",(0,l.kt)("inlineCode",{parentName:"td"},"<name of discoverer>:[<key>[=<value>]]"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"estimator"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},'"binpacking"')),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"expander"),(0,l.kt)("td",{parentName:"tr",align:null},'"random"'),(0,l.kt)("td",{parentName:"tr",align:null},"Type of node group expander to be used in scale up. Available values: ",(0,l.kt)("inlineCode",{parentName:"td"},'["random","most-pods","least-waste","price","priority"]'))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ignore-daemonsets-utilization"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA ignore DaemonSet pods when calculating resource utilization for scaling down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ignore-mirror-pods-utilization"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA ignore Mirror pods when calculating resource utilization for scaling down")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"write-status-configmap"),(0,l.kt)("td",{parentName:"tr",align:null},"true"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA write status information to a configmap")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-inactivity"),(0,l.kt)("td",{parentName:"tr",align:null},'"10m"'),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum time from last recorded autoscaler activity before automatic restart")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-failing-time"),(0,l.kt)("td",{parentName:"tr",align:null},'"15m"'),(0,l.kt)("td",{parentName:"tr",align:null},"Maximum time from last recorded successful autoscaler run before automatic restart")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"balance-similar-node-groups"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Detect similar node groups and balance the number of nodes between them")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"node-autoprovisioning-enabled"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA autoprovision node groups when needed")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"max-autoprovisioned-node-group-count"),(0,l.kt)("td",{parentName:"tr",align:null},"15"),(0,l.kt)("td",{parentName:"tr",align:null},"The maximum number of autoprovisioned groups in the cluster")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"unremovable-node-recheck-timeout"),(0,l.kt)("td",{parentName:"tr",align:null},'"5m"'),(0,l.kt)("td",{parentName:"tr",align:null},"The timeout before we check again a node that couldn't be removed before")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"expendable-pods-priority-cutoff"),(0,l.kt)("td",{parentName:"tr",align:null},"-10"),(0,l.kt)("td",{parentName:"tr",align:null},"Pods with priority below cutoff will be expendable. They can be killed without any consideration during scale down and they don't cause scale up. Pods with null priority (PodPriority disabled) are non expendable")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"regional"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Cluster is regional")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"new-pod-scale-up-delay"),(0,l.kt)("td",{parentName:"tr",align:null},'"0s"'),(0,l.kt)("td",{parentName:"tr",align:null},"Pods less than this old will not be considered for scale-up")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ignore-taint"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Specifies a taint to ignore in node templates when considering to scale a node group")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"balancing-ignore-label"),(0,l.kt)("td",{parentName:"tr",align:null},"-"),(0,l.kt)("td",{parentName:"tr",align:null},"Specifies a label to ignore in addition to the basic and cloud-provider set of labels when comparing if two node groups are similar")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"aws-use-static-instance-list"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Should CA fetch instance types in runtime or use a static list. AWS only")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"profiling"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Is debug/pprof endpoint enabled")))),(0,l.kt)("h4",{id:"deployment"},"Deployment"),(0,l.kt)("p",null,"Based on ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-run-on-master.yaml"},"cluster-autoscaler-run-on-master.yaml")," example, we've created our own ",(0,l.kt)("inlineCode",{parentName:"p"},"cluster-autoscaler-deployment.yaml")," to use preferred ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/aws#auto-discovery-setup"},"auto-discovery setup"),", updating tolerations, nodeSelector, image version and command config:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml"},'---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    k8s-addon: cluster-autoscaler.addons.k8s.io\n    k8s-app: cluster-autoscaler\n  name: cluster-autoscaler\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: cluster-autoscaler\n  labels:\n    k8s-addon: cluster-autoscaler.addons.k8s.io\n    k8s-app: cluster-autoscaler\nrules:\n  - apiGroups: [""]\n    resources: ["events", "endpoints"]\n    verbs: ["create", "patch"]\n  - apiGroups: [""]\n    resources: ["pods/eviction"]\n    verbs: ["create"]\n  - apiGroups: [""]\n    resources: ["pods/status"]\n    verbs: ["update"]\n  - apiGroups: [""]\n    resources: ["endpoints"]\n    resourceNames: ["cluster-autoscaler"]\n    verbs: ["get", "update"]\n  - apiGroups: [""]\n    resources: ["nodes"]\n    verbs: ["watch", "list", "get", "update"]\n  - apiGroups: [""]\n    resources:\n      - "pods"\n      - "services"\n      - "replicationcontrollers"\n      - "persistentvolumeclaims"\n      - "persistentvolumes"\n    verbs: ["watch", "list", "get"]\n  - apiGroups: ["extensions"]\n    resources: ["replicasets", "daemonsets"]\n    verbs: ["watch", "list", "get"]\n  - apiGroups: ["policy"]\n    resources: ["poddisruptionbudgets"]\n    verbs: ["watch", "list"]\n  - apiGroups: ["apps"]\n    resources: ["statefulsets", "replicasets", "daemonsets"]\n    verbs: ["watch", "list", "get"]\n  - apiGroups: ["storage.k8s.io"]\n    resources: ["storageclasses", "csinodes"]\n    verbs: ["watch", "list", "get"]\n  - apiGroups: ["batch", "extensions"]\n    resources: ["jobs"]\n    verbs: ["get", "list", "watch", "patch"]\n  - apiGroups: ["coordination.k8s.io"]\n    resources: ["leases"]\n    verbs: ["create"]\n  - apiGroups: ["coordination.k8s.io"]\n    resourceNames: ["cluster-autoscaler"]\n    resources: ["leases"]\n    verbs: ["get", "update"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cluster-autoscaler\n  namespace: kube-system\n  labels:\n    k8s-addon: cluster-autoscaler.addons.k8s.io\n    k8s-app: cluster-autoscaler\nrules:\n  - apiGroups: [""]\n    resources: ["configmaps"]\n    verbs: ["create","list","watch"]\n  - apiGroups: [""]\n    resources: ["configmaps"]\n    resourceNames: ["cluster-autoscaler-status", "cluster-autoscaler-priority-expander"]\n    verbs: ["delete", "get", "update", "watch"]\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: cluster-autoscaler\n  labels:\n    k8s-addon: cluster-autoscaler.addons.k8s.io\n    k8s-app: cluster-autoscaler\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cluster-autoscaler\nsubjects:\n  - kind: ServiceAccount\n    name: cluster-autoscaler\n    namespace: kube-system\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: cluster-autoscaler\n  namespace: kube-system\n  labels:\n    k8s-addon: cluster-autoscaler.addons.k8s.io\n    k8s-app: cluster-autoscaler\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: cluster-autoscaler\nsubjects:\n  - kind: ServiceAccount\n    name: cluster-autoscaler\n    namespace: kube-system\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cluster-autoscaler\n  namespace: kube-system\n  labels:\n    app: cluster-autoscaler\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cluster-autoscaler\n  template:\n    metadata:\n      labels:\n        app: cluster-autoscaler\n      annotations:\n        prometheus.io/scrape: \'true\'\n        prometheus.io/port: \'8085\'\n    spec:\n      serviceAccountName: cluster-autoscaler\n      tolerations:\n        - effect: NoSchedule\n          operator: "Equal"\n          value: "true"\n          key: node-role.kubernetes.io/controlplane\n      nodeSelector:\n        node-role.kubernetes.io/controlplane: "true"\n      containers:\n        - image: eu.gcr.io/k8s-artifacts-prod/autoscaling/cluster-autoscaler:<VERSION>\n          name: cluster-autoscaler\n          resources:\n            limits:\n              cpu: 100m\n              memory: 300Mi\n            requests:\n              cpu: 100m\n              memory: 300Mi\n          command:\n            - ./cluster-autoscaler\n            - --v=4\n            - --stderrthreshold=info\n            - --cloud-provider=aws\n            - --skip-nodes-with-local-storage=false\n            - --expander=least-waste\n            - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/<clusterName>\n          volumeMounts:\n            - name: ssl-certs\n              mountPath: /etc/ssl/certs/ca-certificates.crt\n              readOnly: true\n          imagePullPolicy: "Always"\n      volumes:\n        - name: ssl-certs\n          hostPath:\n            path: "/etc/ssl/certs/ca-certificates.crt"\n\n')),(0,l.kt)("p",null,"Once the manifest file is prepared, deploy it in the Kubernetes cluster (Rancher UI can be used instead):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sh"},"kubectl -n kube-system apply -f cluster-autoscaler-deployment.yaml\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Note:")," Cluster-autoscaler deployment can also be set up using ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/aws#manual-configuration"},"manual configuration")),(0,l.kt)("h1",{id:"testing"},"Testing"),(0,l.kt)("p",null,"At this point, we should have a cluster-scaler up and running in our Rancher custom cluster. Cluster-scale should manage ",(0,l.kt)("inlineCode",{parentName:"p"},"K8sWorkerAsg")," ASG to scale up and down between 2 and 10 nodes, when one of the following conditions is true:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"There are pods that failed to run in the cluster due to insufficient resources. In this case, the cluster is scaled up."),(0,l.kt)("li",{parentName:"ul"},"There are nodes in the cluster that have been underutilized for an extended period of time and their pods can be placed on other existing nodes. In this case, the cluster is scaled down.")),(0,l.kt)("h3",{id:"generating-load"},"Generating Load"),(0,l.kt)("p",null,"We've prepared a ",(0,l.kt)("inlineCode",{parentName:"p"},"test-deployment.yaml")," just to generate load on the Kubernetes cluster and see if cluster-autoscaler is working properly. The test deployment is requesting 1000m CPU and 1024Mi memory by three replicas. Adjust the requested resources and/or replica to be sure you exhaust the Kubernetes cluster resources:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: hello-world\n  name: hello-world\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: hello-world\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: hello-world\n    spec:\n      containers:\n      - image: rancher/hello-world\n        imagePullPolicy: Always\n        name: hello-world\n        ports:\n        - containerPort: 80\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 1000m\n            memory: 1024Mi\n          requests:\n            cpu: 1000m\n            memory: 1024Mi\n")),(0,l.kt)("p",null,"Once the test deployment is prepared, deploy it in the Kubernetes cluster default namespace (Rancher UI can be used instead):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"kubectl -n default apply -f test-deployment.yaml\n")),(0,l.kt)("h3",{id:"checking-scale"},"Checking Scale"),(0,l.kt)("p",null,"Once the Kubernetes resources got exhausted, cluster-autoscaler should scale up worker nodes where pods failed to be scheduled. It should scale up until up until all pods became scheduled. You should see the new nodes on the ASG and on the Kubernetes cluster. Check the logs on the ",(0,l.kt)("inlineCode",{parentName:"p"},"kube-system")," cluster-autoscaler pod."),(0,l.kt)("p",null,"Once scale up is checked, let check for scale down. To do it, reduce the replica number on the test deployment until you release enough Kubernetes cluster resources to scale down. You should see nodes disappear on the ASG and on the Kubernetes cluster. Check the logs on the ",(0,l.kt)("inlineCode",{parentName:"p"},"kube-system")," cluster-autoscaler pod."))}m.isMDXComponent=!0}}]);